L.LabelTextCollision=L.Canvas.extend({options:{collisionFlg:!0},initialize:function(t){t=L.Util.setOptions(this,t)},_updateTransform:function(t,e){L.Canvas.prototype._updateTransform.call(this,t,e);var i=this._map.getZoomScale(e,this._zoom),n=L.DomUtil.getPosition(this._container),o=this._map.getSize().multiplyBy(.5+this.options.padding),s=this._map.project(this._center,e),a=this._map.project(t,e).subtract(s),r=o.multiplyBy(-i).add(n).add(o).subtract(a);L.Browser.any3d?L.DomUtil.setTransform(this._containerText,r,i):L.DomUtil.setPosition(this._containerText,r)},_initContainer:function(t){L.Canvas.prototype._initContainer.call(this),this._containerText=document.createElement("canvas"),L.DomEvent.on(this._containerText,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this).on(this._containerText,"click dblclick mousedown mouseup contextmenu",this._onClick,this).on(this._containerText,"mouseout",this._handleMouseOut,this),this._ctxLabel=this._containerText.getContext("2d"),L.DomUtil.addClass(this._containerText,"leaflet-zoom-animated"),this.getPane().appendChild(this._containerText)},_update:function(){this._textList=[],L.Renderer.prototype._update.call(this);var t=this._bounds,e=this._containerText,i=t.getSize(),n=L.Browser.retina?2:1;L.DomUtil.setPosition(e,t.min),e.width=n*i.x,e.height=n*i.y,e.style.width=i.x+"px",e.style.height=i.y+"px",e.style.zIndex="4",this._container.style.zIndex="3",L.Browser.retina&&this._ctxLabel.scale(2,2),this._ctxLabel.translate(-t.min.x,-t.min.y),L.Canvas.prototype._update.call(this)},_updatePoly:function(t,e){L.Canvas.prototype._updatePoly.call(this,t,e),this._text(this._ctxLabel,t)},_updateCircle:function(t){L.Canvas.prototype._updateCircle.call(this,t),this._text(this._ctxLabel,t)},_getCenter:function(t){var e,i,n,o,s,a,r,l=t.length;if(!l)return null;for(i=e=0;e<l-1;e++)i+=t[e].distanceTo(t[e+1])/2;if(0===i)return t[0];for(o=e=0;e<l-1;e++)if(s=t[e],a=t[e+1],i<(o+=n=s.distanceTo(a))){r=(o-i)/n;var h=[a.x-r*(a.x-s.x),a.y-r*(a.y-s.y)];return L.point(h[0],h[1])}}}),L.StreetLabels=L.LabelTextCollision.extend({options:{propertyName:"name",showLabelIf:null,interactive:!0,fontStyle:{dynamicFontSize:!1,fontSize:10,fontSizeUnit:"px",lineWidth:4,fillStyle:"black",strokeStyle:"white"}},_handleMouseOut:function(t){var e=this._hoveredLayer;e&&(this._map._mapPane.style.cursor="grab",this._fireEvent([e],t,"mouseout"),this._hoveredLayer=null,this._mouseHoverThrottled=!1)},_handleMouseHover:function(t,e){if(!this._mouseHoverThrottled){for(var i,n,o=this._drawFirst;o;o=o.next)(i=o.layer).options.interactive&&i._containsPoint(e)&&(n=i);n!==this._hoveredLayer&&(this._handleMouseOut(t),n&&(this._map._mapPane.style.cursor="pointer",this._fireEvent([n],t,"mouseover"),this._hoveredLayer=n)),this._hoveredLayer&&this._fireEvent([this._hoveredLayer],t),this._mouseHoverThrottled=!0,setTimeout(L.Util.bind(function(){this._mouseHoverThrottled=!1},this),32)}},_fireEvent:function(t,e,i){this._map._fireDOMEvent(e,i||e.type,t)},initialize:function(t){L.LabelTextCollision.prototype.initialize.call(this,t),L.Util.stamp(this),this._layers=this._layers||{}},_initContainer:function(t){if(L.LabelTextCollision.prototype._initContainer.call(this,t),this._map){var e=function(){this._reset(),this._redraw()}.bind(this);this._map.on("layerremove",L.Util.throttle(e,32,this))}},_text:function(o,t){if(t&&t.feature&&t.feature.properties&&"undefined"!==t.feature.properties[this.options.propertyName]){if(this.options.showLabelIf&&!1===this.options.showLabelIf.call(this,t.feature))return;var e,s=t.feature.properties[this.options.propertyName];if(o.globalAlpha=1,0===t._parts.length||0===t._parts[0].length)return;if(!(e=t instanceof L.Polygon&&this._map.hasLayer(t)?this._getCentroid(t):this._getCenter(t._parts[0])))return;o.lineWidth=this.options.fontStyle.lineWidth;var i=this.options.fontStyle.fontSize;this._map&&!0===this.options.fontStyle.dynamicFontSize&&(i=this._getDynamicFontSize()),o.font=i+this.options.fontStyle.fontSizeUnit+" 'Helvetica Neue',Helvetica,Arial,sans-serif";var n=o.measureText(s).width+e.x,a=e.y+0+20,r=L.bounds(L.point(e.x+0,e.y+0),L.point(n,a));if(this.options.collisionFlg)for(var l in this._textList){if(this._textList[l].intersects(r))return}if(this._textList.push(r),o.fillStyle=this.options.fontStyle.fillStyle,o.strokeStyle=this.options.fontStyle.strokeStyle,t instanceof L.Polygon||t instanceof L.CircleMarker){var h=o.measureText(s).width;o.strokeText(s,e.x+0-h/2,e.y+0),o.fillText(s,e.x+0-h/2,e.y+0)}else if(t instanceof L.Polyline){var _=t.getLatLngs()[0],p=t.getLatLngs()[t.getLatLngs().length-1];this._getBearing(_,p)<0&&(t=this._getLineStringReverse(t)),t._parts&&(o.textAlign="center",o.textBaseline="middle",o.lineWidth=3,t._parts.forEach(function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];e.push(n.x),e.push(n.y)}o.textPath(s,e)}))}}},_getBearing:function(t,e){var i=Math.PI/180,n=t.lat*i,o=e.lat*i,s=t.lng*i,a=e.lng*i,r=Math.sin(a-s)*Math.cos(o),l=Math.cos(n)*Math.sin(o)-Math.sin(n)*Math.cos(o)*Math.cos(a-s),h=(180*Math.atan2(r,l)/Math.PI+360)%360;return 180<=h?h-360:h},_getLineStringReverse:function(t){var e=t.getLatLngs().slice(0).reverse();return t.setLatLngs(e),t},_getDynamicFontSize:function(){return parseInt(this._map.getZoom())},_getCentroid:function(t){if(t&&t.getCenter&&this._map){var e=t.getCenter(),i=this._map.latLngToContainerPoint(e);return this._map.containerPointToLayerPoint(i)}}});